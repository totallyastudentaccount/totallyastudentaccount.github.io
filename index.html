<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YouTube Search + Playlist (Persistent & Editable)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0d0d0d;
      color: white;
      text-align: center;
      padding: 2rem;
    }
    h1 { color: #ff0000; margin-bottom: 1rem; }
    #searchInput {
      width: 70%;
      max-width: 500px;
      padding: 0.7rem;
      font-size: 1rem;
      border-radius: 5px;
      border: 2px solid #ff0000;
      background: #1a1a1a;
      color: white;
    }
    button {
      background: #ff0000;
      color: white;
      border: none;
      padding: 0.7rem 1.2rem;
      font-size: 1rem;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 5px;
    }
    button:hover { background: #cc0000; }

    /* üî• Scrollable results grid */
    #results {
      margin-top: 2rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      max-height: 70vh;
      overflow-y: auto;
      padding: 1rem;
    }

    .video {
      width: 260px;
      background: #1a1a1a;
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.2s ease;
    }
    .video:hover { transform: scale(1.05); }
    .video img {
      width: 100%;
      cursor: pointer;
      user-select: none;
    }
    .video-title { padding: 0.5rem; font-size: 0.9rem; }

    #player-container {
      margin-top: 2rem;
      width: 80%;
      max-width: 800px;
      height: 450px;
      margin-left: auto;
      margin-right: auto;
      border-radius: 8px;
      overflow: hidden;
    }

    #playlist-container {
      margin-top: 3rem;
      text-align: center;
    }

    #playlist {
      list-style: none;
      padding: 0;
      margin-top: 1rem;
    }

    #playlist li {
      background: #1a1a1a;
      padding: 0.5rem;
      margin: 0.3rem auto;
      width: 80%;
      max-width: 500px;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #playlist li:hover { background: #333; }
    #playlist li.active { background: #ff0000; font-weight: bold; }

    .remove-btn {
      background: transparent;
      color: #ff5555;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
    }
    .remove-btn:hover { color: #ff0000; }
  </style>
</head>
<body>
  <h1>üîé YouTube Search + Playlist</h1>
  <input id="searchInput" type="text" placeholder="Search for a YouTube video..." />
  <button onclick="searchVideos()">Search</button>

  <div id="results"></div>

  <div id="playlist-container">
    <h2>üéµ Playlist</h2>
    <button onclick="playPlaylist()">‚ñ∂Ô∏è Play Playlist</button>
    <button onclick="clearPlaylist()">üóëÔ∏è Clear</button>
    <ul id="playlist"></ul>
  </div>

  <div id="player-container">
    <div id="player"></div>
  </div>

  <script>
    let videos = [];
    let player;
    let currentIndex = -1;

    // Load YouTube IFrame API
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '450',
        width: '800',
        videoId: '',
        events: { 'onStateChange': onPlayerStateChange },
        playerVars: { autoplay: 0, controls: 1, rel: 0, modestbranding: 1 }
      });
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.ENDED) playNextInPlaylist();
    }

    async function searchVideos() {
      const query = document.getElementById("searchInput").value.trim();
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      if (!query) {
        alert("Please enter a search term.");
        return;
      }

      try {
        const response = await fetch(`https://corsproxy.io/?https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`);
        const text = await response.text();

        const videoIdMatches = [...text.matchAll(/"videoId":"([a-zA-Z0-9_-]{11})"/g)];
        const titleMatches = [...text.matchAll(/"title":{"runs":\[{"text":"([^"]+)"}\]/g)];

        const videoIds = videoIdMatches.map(match => match[1]);
        const titles = titleMatches.map(match => match[1]);

        const uniqueVideos = [];
        for(let i = 0; i < videoIds.length; i++) {
          if (videoIds[i] && titles[i]) {
            if (!uniqueVideos.find(v => v.id === videoIds[i])) {
              uniqueVideos.push({ id: videoIds[i], title: titles[i] });
            }
          }
        }

        // üî• Show up to 20 results now
        const results = uniqueVideos.slice(0, 20);

        if (results.length === 0) {
          resultsDiv.innerHTML = "<p>No results found.</p>";
          return;
        }

        results.forEach(({id, title}) => {
          const div = document.createElement("div");
          div.className = "video";
          div.innerHTML = `
            <img src="https://img.youtube.com/vi/${id}/mqdefault.jpg" alt="Thumbnail" onclick="playVideo('${id}')" />
            <div class="video-title">${title}</div>
            <button onclick="addToPlaylist('${id}', '${title.replace(/'/g, "\\'")}')">‚ûï Add to Playlist</button>
          `;
          resultsDiv.appendChild(div);
        });
      } catch (error) {
        console.error("Search error:", error);
        resultsDiv.innerHTML = "<p>Failed to fetch search results.</p>";
      }
    }

    function playVideo(id) {
      currentIndex = -1;
      player.loadVideoById(id);
    }

    function addToPlaylist(id, title = id) {
      if (!videos.find(v => v.id === id)) {
        videos.push({ id, title });
        renderPlaylist();
        savePlaylist();
      }
    }

    function removeFromPlaylist(index) {
      videos.splice(index, 1);
      if (index === currentIndex) {
        player.stopVideo();
        currentIndex = -1;
      } else if (index < currentIndex) {
        currentIndex--;
      }
      renderPlaylist();
      savePlaylist();
    }

    function renderPlaylist() {
      const list = document.getElementById("playlist");
      list.innerHTML = videos
        .map((v, i) => {
          const activeClass = (i === currentIndex) ? 'active' : '';
          return `
            <li class="${activeClass}">
              <span onclick="playFromPlaylist(${i})">${i + 1}. ${v.title}</span>
              <button class="remove-btn" onclick="removeFromPlaylist(${i})">‚ùå</button>
            </li>`;
        })
        .join("");
    }

    function playPlaylist() {
      if (videos.length === 0) {
        alert("Add at least one video to the playlist.");
        return;
      }
      currentIndex = 0;
      playFromPlaylist(currentIndex);
    }

    function playFromPlaylist(index) {
      if (index < 0 || index >= videos.length) return;
      currentIndex = index;
      player.loadVideoById(videos[index].id);
      renderPlaylist();
      savePlaylist();
    }

    function playNextInPlaylist() {
      if (currentIndex === -1) return;
      currentIndex++;
      if (currentIndex >= videos.length) currentIndex = 0;
      playFromPlaylist(currentIndex);
    }

    function clearPlaylist() {
      videos = [];
      currentIndex = -1;
      renderPlaylist();
      player.stopVideo();
      savePlaylist();
    }

    function savePlaylist() {
      localStorage.setItem("myPlaylist", JSON.stringify(videos));
    }

    function loadPlaylist() {
      const saved = localStorage.getItem("myPlaylist");
      if (saved) {
        videos = JSON.parse(saved);
        renderPlaylist();
      }
    }

    window.onload = loadPlaylist;
  </script>
</body>
</html>
